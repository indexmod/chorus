<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>C   H   O   R   U   S</title>

<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400..800&family=Verdana:wght@400&display=swap');

body {
  margin:0;
  padding:40px;
  font-family: Verdana, sans-serif;
  background:#fff;
  color:#000;
}

h1 {
  font-family:'EB Garamond', serif;
  font-weight:lighter;
  font-size:clamp(48px,10vw,200px);
  margin:0 0 10px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

h2 {
  font-family:'Permanent Marker', cursive;
  font-weight:normal;
  font-size:clamp(24px,5vw,100px);
  margin:0 0 40px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.container {
  max-width:1200px;
  width:calc(100vw - 80px);
  margin-bottom:40px;
  font-size:20px;
  line-height:1.3;
}

/* Masonry grid */
.grid {
  column-count: 4;
  column-gap: 1px;
}

.item {
  display: inline-block;
  width: 100%;
  margin: 0 0 1px;
  position: relative;
  cursor: pointer;
}

.item img,
.item video,
.item iframe {
  width: 100%;
  display:block;
  object-fit: cover;
  border:none;
}

.item .number {
  position:absolute;
  left:5px;
  bottom:5px;
  width:25px;
  height:25px;
  border-radius:50%;
  background:black;
  color:white;
  font-size:14px;
  font-weight:bold;
  display:flex;
  justify-content:center;
  align-items:center;
}

.names-section {
  margin-top:40px;
  font-size:16px;
}

@media (max-width:1200px){ .grid{column-count:3;} }
@media (max-width:900px){ .grid{column-count:2;} }
@media (max-width:600px){ .grid{column-count:1;} }
</style>

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='black' /%3E%3Ccircle cx='35' cy='35' r='5' fill='white' /%3E%3Ccircle cx='65' cy='35' r='5' fill='white' /%3E%3Ccircle cx='50' cy='65' r='5' fill='white' /%3E%3C/svg%3E" type="image/svg+xml">

</head>
<body>

<h1>C   H   O   R   U   S</h1>
<h2>by Andr o Dei</h2>

<div class="container">
  <p>
    Описание каталога коллекции, где скульптура, живопись, принты и мультимедиа объединяются исследованием эмодзи, иероглифа, человеческого лица и упрощённой допиктограммы.
    Перейти к <a href="#namesLine" style="display:inline-block;background:#ddd;padding:2px 6px;border-radius:10px;text-decoration:none;color:black;"><strong>списку имён</strong></a>.
  </p>
</div>

<div class="grid" id="previewGrid"></div>

<div class="names-section">
  <h3>Имена, соответствующие номерам:</h3>
  <p id="namesLine"></p>
</div>

<script type="module">
const repo = "indexmod/chorus";
const grid = document.getElementById('previewGrid');
const namesLine = document.getElementById("namesLine");
const excludedFiles = ["DC Store"];

let dummyNamesXML = `
<names>
  <name>Yan</name>
  <name>Feb</name>
  <name>Mar</name>
  <name>Apr</name>
  <name>May</name>
  <name>Jun</name>
  <name>Jul</name>
  <name>Aug</name>
  <name>Sep</name>
  <name>Oct</name>
  <name>Nov</name>
  <name>Dec</name>
</names>
`;

const parser = new DOMParser();
const xmlDoc = parser.parseFromString(dummyNamesXML, "application/xml");
const nameNodes = Array.from(xmlDoc.querySelectorAll("name"));

let counter = 1;
let namesLineText = "";

function getNameForIndex(index){
  if(index <= nameNodes.length){
    return nameNodes[index-1].textContent;
  } else {
    return `New ${index}`;
  }
}

function addPreview(url,type){
  const item = document.createElement('div');
  item.className='item';

  let content;
  if(type==='html'){
    content=document.createElement('iframe'); content.src=url;
  } else if(type==='image'){
    content=document.createElement('img'); content.src=url;
  } else if(type==='video'){
    content=document.createElement('video');
    content.src=url;
    content.autoplay=true;
    content.muted=true;
    content.playsInline=true;
    content.loop=true;
  } else{
    content=document.createElement('a'); content.href=url; content.target='_blank';
  }

  item.appendChild(content);

  const number = document.createElement('div');
  number.className='number';
  number.textContent=counter;
  item.appendChild(number);

  const name = getNameForIndex(counter);
  if(counter>1) namesLineText += "; ";
  namesLineText += `${counter}. ${name}`;
  namesLine.textContent = namesLineText;

  counter++;

  item.addEventListener('click',()=>window.open(url,'_blank'));

  grid.appendChild(item);
}

async function loadRepoPreviews(){
  try{
    const response = await fetch(`https://api.github.com/repos/${repo}/contents/`);
    if(!response.ok) throw new Error(`HTTP ошибка: ${response.status}`);
    const files=await response.json();
    const owner=repo.split('/')[0];
    const repoName=repo.split('/')[1];

    for(const f of files){
      // пропускаем index.html, скрытые файлы и явно исключенные
      if(/^index\.html?$/i.test(f.name) || f.name.startsWith('.') || excludedFiles.includes(f.name)) continue;

      const url=`https://${owner}.github.io/${repoName}/${f.name}`;

      if(f.name.endsWith('.html')) addPreview(url,'html');
      else if(f.name.endsWith('.webloc')){
        const res=await fetch(f.download_url);
        const text=await res.text();
        const xmlDocLocal=new DOMParser().parseFromString(text,"application/xml");
        const urlNode=xmlDocLocal.querySelector("string");
        if(urlNode?.textContent) addPreview(urlNode.textContent,'html');
      }
      else if(/\.(png|jpg|jpeg|gif|webp)$/i.test(f.name)) addPreview(url,'image');
      else if(/\.(mp4|webm|mov)$/i.test(f.name)) addPreview(url,'video');
      else addPreview(url,'other');
    }
  }catch(e){console.error("Ошибка при загрузке файлов:",e);}
}

loadRepoPreviews();
</script>
</body>
</html>
