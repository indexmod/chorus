<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CHORUS</title>
<style>
  body { margin:0; padding:20px; background:#fff; }
  h1 { font-family:'EB Garamond', serif; font-size:clamp(48px,10vw,200px); margin:0 0 20px; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    grid-auto-rows: 5px; /* маленькая базовая высота для span расчёта */
    gap: 1px;
  }
  .item { width:100%; overflow:hidden; cursor:pointer; }
  .item img,
  .item video,
  .item iframe { width:100%; height:auto; display:block; }

</style>
</head>
<body>
<h1>CHORUS</h1>
<div class="grid" id="previewGrid"></div>

<script type="module">
const repo = "indexmod/chorus";
const grid = document.getElementById('previewGrid');
const excludedFiles = ["DC Store"];

function addPreview(url, type) {
  const item = document.createElement('div');
  item.className = 'item';

  let content;
  if(type==='html'){
    content = document.createElement('iframe'); content.src=url;
  } else if(type==='image'){
    content = document.createElement('img'); content.src=url;
  } else if(type==='video'){
    content = document.createElement('video'); content.src=url; content.controls=false;
  } else{
    content = document.createElement('a'); content.href=url; content.target='_blank';
  }

  item.appendChild(content);
  item.addEventListener('click',()=>window.open(url,'_blank'));

  content.addEventListener('load',()=>{ // для img/iframe определяем span по высоте
    const rowHeight = parseInt(getComputedStyle(grid).getPropertyValue('grid-auto-rows'));
    const rowGap = parseInt(getComputedStyle(grid).getPropertyValue('gap'));
    const span = Math.ceil((content.getBoundingClientRect().height + rowGap)/ (rowHeight + rowGap));
    item.style.gridRowEnd = 'span ' + span;
  });

  grid.appendChild(item);
}

async function loadRepoPreviews(){
  try{
    const response = await fetch(`https://api.github.com/repos/${repo}/contents/`);
    if(!response.ok) throw new Error(`HTTP ошибка: ${response.status}`);
    const files = await response.json();
    const owner = repo.split('/')[0];
    const repoName = repo.split('/')[1];

    for(const f of files){
      if(/^index\.html?$/i.test(f.name) || excludedFiles.includes(f.name)) continue;
      const url = `https://${owner}.github.io/${repoName}/${f.name}`;
      if(f.name.endsWith('.html')) addPreview(url,'html');
      else if(f.name.endsWith('.webloc')){
        const res = await fetch(f.download_url);
        const text = await res.text();
        const xmlDoc = new DOMParser().parseFromString(text,"application/xml");
        const urlNode = xmlDoc.querySelector("string");
        if(urlNode?.textContent) addPreview(urlNode.textContent,'html');
      }
      else if(/\.(png|jpg|jpeg|gif|webp)$/i.test(f.name)) addPreview(url,'image');
      else if(/\.(mp4|webm|mov)$/i.test(f.name)) addPreview(url,'video');
      else addPreview(url,'other');
    }
  }catch(e){ console.error("Ошибка при загрузке файлов:",e);}
}

loadRepoPreviews();
</script>
</body>
</html>
