<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Маски по сетке (исправлено)</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
    }
    #startBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      z-index: 9999;
    }
    img {
      position: absolute;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <button id="startBtn">▶ Старт</button>

  <script>
    const maskSize = 50;          // размер PNG
    const cellSize = maskSize + 2; // шаг сетки (зазор 2px)
    let maskCount = 0;
    let audioCtx = null;

    // --- Маска ---
    function createMask(size) {
      const faceR = 45; // круг чуть больше, ближе к краям

      // глаза ближе к центру
      const eyeBaseY = 40 + Math.random() * 4;
      const eyeBaseX = 38 + Math.random() * 2;
      const eyeGap = 20 + Math.random() * 4;

      const eyeR = 3 + Math.random() * 4; // уменьшены

      // рот ниже центра, но компактный
      const mouthY = 60 + Math.random() * 4;
      const mouthR = 5 + Math.random() * 6; // меньше

      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="${faceR}" fill="#ffffff"/>
          <circle cx="${eyeBaseX}" cy="${eyeBaseY}" r="${eyeR.toFixed(1)}" fill="#000000"/>
          <circle cx="${eyeBaseX + eyeGap}" cy="${eyeBaseY}" r="${eyeR.toFixed(1)}" fill="#000000"/>
          <circle cx="50" cy="${mouthY}" r="${mouthR.toFixed(1)}" fill="#000000"/>
        </svg>
      `;
    }

    // --- SVG → PNG (с прозрачным фоном) ---
    function svgToPng(svgStr, size, callback) {
      const img = new Image();
      const svgBlob = new Blob([svgStr], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);

      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, size, size);
        ctx.drawImage(img, 0, 0, size, size);

        const pngUrl = canvas.toDataURL("image/png");
        URL.revokeObjectURL(url);
        callback(pngUrl);
      };
      img.src = url;
    }

    // --- Звук ---
    function playTone(progress) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      const minFreq = 100;
      const maxFreq = 1200;
      const freq = minFreq + progress * (maxFreq - minFreq);

      osc.frequency.value = freq;
      osc.type = "sine";

      gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(
        0.001,
        audioCtx.currentTime + 0.25
      );

      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.25);
    }

    // --- Координаты спирали (по клеткам) ---
    function spiralCoords(n) {
      let x = 0, y = 0;
      let dx = 1, dy = 0;
      let step = 1, stepsTaken = 0, turn = 0;
      for (let i = 0; i < n; i++) {
        if (stepsTaken === step) {
          stepsTaken = 0;
          turn++;
          [dx, dy] = [-dy, dx]; // поворот по часовой стрелке
          if (turn % 2 === 0) step++;
        }
        x += dx;
        y += dy;
        stepsTaken++;
      }
      return {x, y};
    }

    // --- Проверка выхода за экран ---
    function isOutOfBounds(px, py) {
      return (
        px - maskSize / 2 < 0 ||
        py - maskSize / 2 < 0 ||
        px + maskSize / 2 > window.innerWidth ||
        py + maskSize / 2 > window.innerHeight
      );
    }

    // --- Добавление маски ---
    function addMask() {
      const {x, y} = spiralCoords(maskCount);
      const centerX = Math.floor(window.innerWidth / 2);
      const centerY = Math.floor(window.innerHeight / 2);
      const px = centerX + x * cellSize;
      const py = centerY + y * cellSize;

      if (isOutOfBounds(px, py)) {
        // очищаем и начинаем заново
        document.querySelectorAll("img").forEach(el => el.remove());
        maskCount = 0;
        return;
      }

      const svg = createMask(maskSize);
      svgToPng(svg, maskSize, (pngUrl) => {
        const img = document.createElement("img");
        img.src = pngUrl;
        img.width = maskSize;
        img.height = maskSize;
        img.style.left = px + "px";
        img.style.top = py + "px";
        document.body.appendChild(img);
      });

      const progress = (maskCount % 100) / 100;
      playTone(progress);

      maskCount++;
    }

    // --- Запуск ---
    document.getElementById("startBtn").addEventListener("click", async () => {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
      }
      document.getElementById("startBtn").style.display = "none";

      setInterval(() => {
        addMask();
      }, 150);
    });
  </script>
</body>
</html>
